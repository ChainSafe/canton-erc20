# Canton ERC-20 Local Guide

This guide mirrors the behaviour of `scripts/bootstrap.sh` and shows how to interact with the ledger, Go indexer, and middleware using the exports generated by the bootstrap script.

## 1. Bootstrap the sandbox

```bash
./scripts/bootstrap.sh
```

The script:
- builds the DAR in `daml/`;
- starts (or reuses) the sandbox on `${SANDBOX_PORT:-6865}`;
- uploads the DAR and runs `ERC20.Script:test` and `ERC20.Inspect:balancesOk`; 
- allocates Issuer/Alice/Bob on the ledger;
- writes helper exports (package id, party ids) to `dev-env.sh`.

## 2. Load the helper environment exports

```bash
source dev-env.sh
```

The file defines values such as `LEDGER_ID`, `SANDBOX_PORT`, `ERC20_PKG_ID`, `ISSUER_PARTY`, `ALICE_PARTY`, and `BOB_PARTY`. Re-source this file in any terminal where you plan to run the indexer, middleware, or manual commands.

## 3. Start the Go indexer

```bash
source dev-env.sh
export INDEXER_PARTY=$ISSUER_PARTY
cd indexer-go
./scripts/gen-ledger.sh   # requires protoc + protoc-gen-go/grpc
go mod tidy               # downloads Go dependencies (requires network)
GOMODCACHE=$(pwd)/.gomodcache GOCACHE=$(pwd)/.gocache go run ./cmd/indexer
```

The indexer connects to the Ledger gRPC API and exposes REST endpoints on `${PORT:-9000}`. Example queries:

```bash
curl "http://localhost:9000/balanceOf?party=$ALICE_PARTY"
curl "http://localhost:9000/allowance?owner=$ALICE_PARTY&spender=$BOB_PARTY"
curl "http://localhost:9000/totalSupply"
```

## 4. Start the middleware (gRPC)

```bash
cd middleware
npm install
npm start
```

The middleware listens on `${PORT:-50051}` and proxies `BalanceOf`, `TotalSupply`, and `Allowance` to the indexer. Query it with `grpcurl`:

```bash
grpcurl -plaintext \
  -import-path middleware/proto \
  -proto erc20.proto \
  -d '{"token":{"symbol":"CCN"},"owner":{"party":"'"$ALICE_PARTY"'"}}' \
  localhost:50051 canton.erc20.v1.ERC20Service/BalanceOf
```

## 5. Using Daml scripts for ledger mutations

The supplied Daml scripts remain the easiest way to mint/transfer tokens during development:

```bash
cd daml
source ../dev-env.sh

daml script \
  --ledger-host localhost \
  --ledger-port ${SANDBOX_PORT} \
  --dar ./.daml/dist/erc20-canton-0.0.1.dar \
  --script-name ERC20.Script:test
```

You can add additional Daml scripts (e.g. to mint, transfer, or inspect balances) and run them the same way. The Go indexer will pick up changes automatically via the transaction stream.

## 6. Shutdown

- Ctrl+C in the indexer and middleware terminals.
- To stop the sandbox started by `bootstrap.sh`, terminate the process recorded in `log/sandbox-bootstrap.pid`, or simply close the terminal session that launched it.

## Troubleshooting

| Symptom | Fix |
| ------- | --- |
| `ERC20_PKG_ID` or `INDEXER_PARTY` missing | `source dev-env.sh` (and export `INDEXER_PARTY=$ISSUER_PARTY`). |
| Ledger connection refused | Ensure the sandbox is running (`./scripts/bootstrap.sh`). |
| `CONTRACT_NOT_FOUND` when exercising transfers twice | Re-run the query in ยง3 to refresh the holding CID before submitting again. |
