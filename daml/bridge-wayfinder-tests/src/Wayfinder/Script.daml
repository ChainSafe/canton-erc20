-- | Wayfinder Script - Simple smoke test for issuer-centric bridge

module Wayfinder.Script where

import Daml.Script
import DA.Time (time)
import DA.Date (date, Month(..))
import Common.Types
import Common.FingerprintAuth (FingerprintMapping(..))
import Splice.Api.Token.HoldingV1 (InstrumentId(..))
import CIP56.Token
import CIP56.Config (TokenConfig(..))
import Wayfinder.Bridge

testFullCycle : Script ()
testFullCycle = script do
  issuer <- allocateParty "BridgeIssuer"
  alice <- allocateParty "Alice"

  let instrumentId = promptInstrumentId issuer

  tokenManagerCid <- submit issuer do
    createCmd CIP56Manager with
      issuer = issuer
      instrumentId
      meta = promptMetadata

  tokenConfigCid <- submit issuer do
    createCmd TokenConfig with
      issuer = issuer
      tokenManagerCid = tokenManagerCid
      instrumentId
      meta = promptMetadata
      auditObservers = []

  configCid <- submit issuer do
    createCmd WayfinderBridgeConfig with
      issuer = issuer
      tokenConfigCid = tokenConfigCid
      auditObservers = []

  let aliceFingerprint = "1220aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"

  aliceMappingCid <- submit issuer do
    createCmd FingerprintMapping with
      issuer = issuer
      userParty = alice
      fingerprint = aliceFingerprint
      evmAddress = Some (EvmAddress "0xAliceEthWallet...")

  let testTime = time (date 2025 Jan 1) 12 0 0

  depositCid <- submit issuer do
    exerciseCmd configCid CreatePendingDeposit with
      fingerprint = aliceFingerprint
      amount = 100.0
      evmTxHash = "0xDepositTx..."
      timestamp = testTime

  (holdingCid, _mintEventCid) <- submit issuer do
    exerciseCmd configCid ProcessDepositAndMint with
      depositCid = depositCid
      mappingCid = aliceMappingCid
      timestamp = testTime

  Some holding <- queryContractId alice holdingCid
  assertMsg "Alice received PROMPT" (holding.amount == 100.0)
  assertMsg "Correct InstrumentId" (holding.instrumentId == instrumentId)
  assertMsg "Symbol in metadata" (getSymbol holding.meta == "PROMPT")

  debug "Smoke test passed!"
  pure ()
