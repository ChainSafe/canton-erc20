-- | Wayfinder Script - Simple smoke test for issuer-centric bridge
--
-- For comprehensive tests, see Wayfinder.Test

module Wayfinder.Script where

import Daml.Script
import DA.Time (time)
import DA.Date (date, Month(..))
import Common.Types
import CIP56.Token
import CIP56.Config (TokenConfig(..))
import Wayfinder.Bridge

-- | Simple smoke test for the issuer-centric bridge
testFullCycle : Script ()
testFullCycle = script do
  -- 1. Setup: Issuer is the participant node operator
  issuer <- allocateParty "BridgeIssuer"
  alice <- allocateParty "Alice"
  
  -- 2. Deploy Token Manager for PROMPT
  tokenManagerCid <- submit issuer do
    createCmd CIP56Manager with
      issuer = issuer
      meta = promptMetadata

  -- 3. Deploy TokenConfig (unified mint/burn)
  tokenConfigCid <- submit issuer do
    createCmd TokenConfig with
      issuer = issuer
      tokenManagerCid = tokenManagerCid
      meta = promptMetadata
      auditObservers = []

  -- 4. Deploy Bridge Config (delegates to TokenConfig)
  configCid <- submit issuer do
    createCmd WayfinderBridgeConfig with
      issuer = issuer
      tokenConfigCid = tokenConfigCid
      auditObservers = []

  -- 5. Register Alice (issuer creates fingerprint mapping)
  let aliceFingerprint = "1220aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
  
  aliceMappingCid <- submit issuer do
    exerciseCmd configCid RegisterUser with
      userParty = alice
      fingerprint = aliceFingerprint
      evmAddress = Some (EvmAddress "0xAliceEthWallet...")

  -- 6. DEPOSIT FLOW (Ethereum -> Canton)
  let testTime = time (date 2025 Jan 1) 12 0 0
  
  -- Middleware sees deposit event, creates PendingDeposit
  depositCid <- submit issuer do
    exerciseCmd configCid CreatePendingDeposit with
      fingerprint = aliceFingerprint
      amount = 100.0
      evmTxHash = "0xDepositTx..."
      timestamp = testTime

  -- Issuer processes deposit and mints (returns holding + audit event)
  (holdingCid, _mintEventCid) <- submit issuer do
    exerciseCmd configCid ProcessDepositAndMint with
      depositCid = depositCid
      mappingCid = aliceMappingCid
      timestamp = testTime

  -- Verify Alice has funds
  Some holding <- queryContractId alice holdingCid
  assertMsg "Alice received PROMPT" (holding.amount == 100.0)
  assertMsg "Correct Symbol" (holding.meta.symbol == "PROMPT")

  debug "Smoke test passed!"
  
  pure ()
