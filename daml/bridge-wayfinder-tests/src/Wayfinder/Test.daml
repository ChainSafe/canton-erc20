-- | Wayfinder Bridge Tests - Unified Token Architecture (Splice-compliant)

module Wayfinder.Test where

import Daml.Script
import DA.Time (time)
import DA.Date (date, Month(..))
import Common.Types
import Common.FingerprintAuth (FingerprintMapping(..))
import Splice.Api.Token.HoldingV1 (InstrumentId(..))
import CIP56.Token
import CIP56.Config (TokenConfig(..), IssuerMint(..))
import Bridge.Contracts
import Wayfinder.Bridge

testIssuerCentricBridge : Script ()
testIssuerCentricBridge = script do
  debug ">>> 1. Issuer deploys bridge..."

  issuer <- allocateParty "BridgeIssuer"
  auditor <- allocateParty "Auditor"
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"

  let instrumentId = promptInstrumentId issuer

  tokenManagerCid <- submit issuer do
    createCmd CIP56Manager with
      issuer = issuer
      instrumentId
      meta = promptMetadata

  tokenConfigCid <- submit issuer do
    createCmd TokenConfig with
      issuer = issuer
      tokenManagerCid = tokenManagerCid
      instrumentId
      meta = promptMetadata
      auditObservers = [auditor]

  configCid <- submit issuer do
    createCmd WayfinderBridgeConfig with
      issuer = issuer
      tokenConfigCid = tokenConfigCid
      auditObservers = [auditor]

  debug "    [OK] Bridge deployed."

  debug ">>> 2. Register fingerprints..."

  let aliceFingerprint = "1220aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
  let bobFingerprint   = "1220bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb"

  aliceMappingCid <- submit issuer do
    createCmd FingerprintMapping with
      issuer = issuer
      userParty = alice
      fingerprint = aliceFingerprint
      evmAddress = Some (EvmAddress "0xAliceEthWallet...")

  bobMappingCid <- submit issuer do
    createCmd FingerprintMapping with
      issuer = issuer
      userParty = bob
      fingerprint = bobFingerprint
      evmAddress = Some (EvmAddress "0xBobEthWallet...")

  debug "    [OK] Users registered."

  debug ">>> 3. Alice deposits 100.0 PROMPT..."

  let testTime = time (date 2025 Jan 1) 12 0 0

  aliceDepositCid <- submit issuer do
    exerciseCmd configCid CreatePendingDeposit with
      fingerprint = aliceFingerprint
      amount = 100.0
      evmTxHash = "0xAliceDepositTx..."
      timestamp = testTime

  (aliceHoldingCid, mintEventCid) <- submit issuer do
    exerciseCmd configCid ProcessDepositAndMint with
      depositCid = aliceDepositCid
      mappingCid = aliceMappingCid
      timestamp = testTime

  Some aliceHolding <- queryContractId alice aliceHoldingCid
  assertMsg "Alice should have 100.0 PROMPT" (aliceHolding.amount == 100.0)
  assertMsg "Correct instrumentId" (aliceHolding.instrumentId == instrumentId)

  Some mintEvent <- queryContractId issuer mintEventCid
  assertMsg "Mint event amount correct" (mintEvent.amount == 100.0)
  assertMsg "Mint event tokenSymbol correct" (mintEvent.tokenSymbol == "PROMPT")
  assertMsg "Mint event evmTxHash set" (mintEvent.evmTxHash == Some "0xAliceDepositTx...")

  Some mintEventFromAuditor <- queryContractId auditor mintEventCid
  assertMsg "Auditor can see mint event" (mintEventFromAuditor.amount == 100.0)

  debug "    [OK] Alice received 100.0 PROMPT."

  debug ">>> 4. Direct mint 40.0 PROMPT to Bob..."

  let bobMintTime = time (date 2025 Jan 1) 14 0 0

  (bobHoldingCid, bobMintEventCid) <- submit issuer do
    exerciseCmd tokenConfigCid IssuerMint with
      recipient = bob
      amount = 40.0
      eventTime = bobMintTime
      userFingerprint = bobFingerprint
      evmTxHash = Some "admin-mint"

  Some bobHolding <- queryContractId bob bobHoldingCid
  assertMsg "Bob should have 40.0 PROMPT" (bobHolding.amount == 40.0)

  debug "    [OK] Bob has 40.0 PROMPT."

  debug ">>> 5. Bob withdraws 40.0 PROMPT..."

  withdrawalRequestCid <- submit issuer do
    exerciseCmd configCid InitiateWithdrawal with
      mappingCid = bobMappingCid
      holdingCid = bobHoldingCid
      amount = 40.0
      evmDestination = EvmAddress "0xBobEthWallet..."

  let withdrawalTime = time (date 2025 Jan 1) 16 0 0
  (withdrawalEventCid, burnEventCid) <- submit issuer do
    exerciseCmd withdrawalRequestCid ProcessWithdrawal with
      timestamp = withdrawalTime

  Some withdrawalEvent <- queryContractId issuer withdrawalEventCid
  assertMsg "Withdrawal amount correct" (withdrawalEvent.amount == 40.0)
  assertMsg "Withdrawal tokenSymbol correct" (withdrawalEvent.tokenSymbol == "PROMPT")

  Some burnEvent <- queryContractId issuer burnEventCid
  assertMsg "Burn event amount correct" (burnEvent.amount == 40.0)
  assertMsg "Burn event evmDestination set" (burnEvent.evmDestination == Some "0xBobEthWallet...")

  Some burnEventFromAuditor <- queryContractId auditor burnEventCid
  assertMsg "Auditor can see burn event" (burnEventFromAuditor.amount == 40.0)

  debug "    [OK] Withdrawal event created."

  debug ">>> 6. Complete withdrawal..."

  completedEventCid <- submit issuer do
    exerciseCmd withdrawalEventCid CompleteWithdrawal with
      evmTxHash = "0xBobEvmReleaseTx..."

  Some completedEvent <- queryContractId issuer completedEventCid
  case completedEvent.status of
    Completed txHash -> assertMsg "EVM tx hash recorded" (txHash == "0xBobEvmReleaseTx...")
    _ -> fail "Expected Completed status"

  debug "    [OK] Withdrawal complete."
  debug ">>> Bridge test passed!"
  pure ()

testFingerprintMismatchRejected : Script ()
testFingerprintMismatchRejected = script do
  issuer <- allocateParty "BridgeIssuer"
  alice <- allocateParty "Alice"

  let instrumentId = promptInstrumentId issuer

  tokenManagerCid <- submit issuer do
    createCmd CIP56Manager with
      issuer = issuer
      instrumentId
      meta = promptMetadata

  tokenConfigCid <- submit issuer do
    createCmd TokenConfig with
      issuer = issuer
      tokenManagerCid = tokenManagerCid
      instrumentId
      meta = promptMetadata
      auditObservers = []

  configCid <- submit issuer do
    createCmd WayfinderBridgeConfig with
      issuer = issuer
      tokenConfigCid = tokenConfigCid
      auditObservers = []

  let aliceFingerprint = "1220aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
  aliceMappingCid <- submit issuer do
    createCmd FingerprintMapping with
      issuer = issuer
      userParty = alice
      fingerprint = aliceFingerprint
      evmAddress = None

  let wrongFingerprint = "1220cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc"
  let testTime = time (date 2025 Jan 1) 12 0 0

  depositCid <- submit issuer do
    exerciseCmd configCid CreatePendingDeposit with
      fingerprint = wrongFingerprint
      amount = 50.0
      evmTxHash = "0xWrongDeposit..."
      timestamp = testTime

  submitMustFail issuer do
    exerciseCmd configCid ProcessDepositAndMint with
      depositCid = depositCid
      mappingCid = aliceMappingCid
      timestamp = testTime

  debug "Fingerprint mismatch correctly rejected."
  pure ()

testMultipleUsers : Script ()
testMultipleUsers = script do
  issuer <- allocateParty "BridgeIssuer"
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  carol <- allocateParty "Carol"
  auditor <- allocateParty "Auditor"

  let instrumentId = promptInstrumentId issuer

  tokenManagerCid <- submit issuer do
    createCmd CIP56Manager with
      issuer = issuer
      instrumentId
      meta = promptMetadata

  tokenConfigCid <- submit issuer do
    createCmd TokenConfig with
      issuer = issuer
      tokenManagerCid = tokenManagerCid
      instrumentId
      meta = promptMetadata
      auditObservers = [auditor]

  configCid <- submit issuer do
    createCmd WayfinderBridgeConfig with
      issuer = issuer
      tokenConfigCid = tokenConfigCid
      auditObservers = [auditor]

  let aliceFp = "1220aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
  let bobFp   = "1220bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb"
  let carolFp = "1220cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc"

  aliceMapping <- submit issuer do
    createCmd FingerprintMapping with issuer, userParty = alice, fingerprint = aliceFp, evmAddress = None
  bobMapping <- submit issuer do
    createCmd FingerprintMapping with issuer, userParty = bob, fingerprint = bobFp, evmAddress = None
  carolMapping <- submit issuer do
    createCmd FingerprintMapping with issuer, userParty = carol, fingerprint = carolFp, evmAddress = None

  let testTime = time (date 2025 Jan 1) 12 0 0

  aliceDeposit <- submit issuer do
    exerciseCmd configCid CreatePendingDeposit with
      fingerprint = aliceFp, amount = 100.0, evmTxHash = "0xAlice...", timestamp = testTime
  (aliceHolding, aliceMintEvent) <- submit issuer do
    exerciseCmd configCid ProcessDepositAndMint with
      depositCid = aliceDeposit, mappingCid = aliceMapping, timestamp = testTime

  bobDeposit <- submit issuer do
    exerciseCmd configCid CreatePendingDeposit with
      fingerprint = bobFp, amount = 200.0, evmTxHash = "0xBob...", timestamp = testTime
  (bobHolding, bobMintEvent) <- submit issuer do
    exerciseCmd configCid ProcessDepositAndMint with
      depositCid = bobDeposit, mappingCid = bobMapping, timestamp = testTime

  carolDeposit <- submit issuer do
    exerciseCmd configCid CreatePendingDeposit with
      fingerprint = carolFp, amount = 300.0, evmTxHash = "0xCarol...", timestamp = testTime
  (carolHolding, carolMintEvent) <- submit issuer do
    exerciseCmd configCid ProcessDepositAndMint with
      depositCid = carolDeposit, mappingCid = carolMapping, timestamp = testTime

  Some ah <- queryContractId alice aliceHolding
  Some bh <- queryContractId bob bobHolding
  Some ch <- queryContractId carol carolHolding

  assertMsg "Alice amount" (ah.amount == 100.0)
  assertMsg "Bob amount" (bh.amount == 200.0)
  assertMsg "Carol amount" (ch.amount == 300.0)

  Some amFromAuditor <- queryContractId auditor aliceMintEvent
  Some bmFromAuditor <- queryContractId auditor bobMintEvent
  Some cmFromAuditor <- queryContractId auditor carolMintEvent

  assertMsg "Auditor sees Alice event" (amFromAuditor.amount == 100.0)
  assertMsg "Auditor sees Bob event" (bmFromAuditor.amount == 200.0)
  assertMsg "Auditor sees Carol event" (cmFromAuditor.amount == 300.0)

  debug "Multiple users test passed!"
  pure ()
