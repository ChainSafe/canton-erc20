module CIP56.Script where

import Daml.Script
import DA.Time (time, hours, addRelTime)
import DA.Date (date, Month(..))
import Splice.Api.Token.MetadataV1 (ExtraArgs(..), emptyMetadata, emptyChoiceContext)
import Splice.Api.Token.HoldingV1 (Holding(..), InstrumentId(..))
import Splice.Api.Token.TransferInstructionV1

import CIP56.Token
import CIP56.TransferFactory (CIP56TransferFactory(..))

allocateTestParty : Text -> Script Party
allocateTestParty name = allocatePartyByHint (PartyIdHint name)

testMintAndBurn : Script ()
testMintAndBurn = script do
  issuer <- allocateTestParty "issuer"
  alice  <- allocateTestParty "alice"

  let instrumentId = InstrumentId with admin = issuer, id = "CCN"
  let meta = mkMetadata
        [ ("splice.chainsafe.io/name", "Canton Coin")
        , ("splice.chainsafe.io/symbol", "CCN")
        , ("splice.chainsafe.io/decimals", "6")
        ]

  tmCid <- submit issuer do
    createCmd CIP56Manager with issuer, instrumentId, meta

  holdingCid <- submit issuer do
    exerciseCmd tmCid Mint with to = alice, amount = 100.0

  Some h <- queryContractId alice holdingCid
  assertMsg "Alice has 100" (h.amount == 100.0)
  assertMsg "instrumentId matches" (h.instrumentId == instrumentId)
  assertMsg "not locked" (h.lock == None)

  remainderCid <- submit issuer do
    exerciseCmd tmCid Burn with holdingCid, amount = 40.0

  case remainderCid of
    Some cid -> do
      Some r <- queryContractId alice cid
      assertMsg "Remainder is 60" (r.amount == 60.0)
    None -> fail "Expected remainder"

  debug "Mint and burn test passed!"
  pure ()

testTransferViaFactory : Script ()
testTransferViaFactory = script do
  issuer <- allocateTestParty "issuer"
  alice  <- allocateTestParty "alice"
  bob    <- allocateTestParty "bob"

  let instrumentId = InstrumentId with admin = issuer, id = "TEST"
  let meta = mkMetadata
        [ ("splice.chainsafe.io/name", "Test Token")
        , ("splice.chainsafe.io/symbol", "TEST")
        , ("splice.chainsafe.io/decimals", "18")
        ]

  tmCid <- submit issuer do
    createCmd CIP56Manager with issuer, instrumentId, meta

  aliceHolding <- submit issuer do
    exerciseCmd tmCid Mint with to = alice, amount = 500.0

  factoryCid <- submit issuer do
    createCmd CIP56TransferFactory with admin = issuer

  let now = time (date 2025 Jan 15) 12 0 0
  setTime now

  result <- submitMulti [alice] [issuer] do
    exerciseCmd (toInterfaceContractId @TransferFactory factoryCid) TransferFactory_Transfer with
      expectedAdmin = issuer
      transfer = Transfer with
        sender = alice
        receiver = bob
        amount = 200.0
        instrumentId
        requestedAt = now
        executeBefore = addRelTime now (hours 1)
        inputHoldingCids = [toInterfaceContractId @Holding aliceHolding]
        meta = emptyMetadata
      extraArgs = ExtraArgs with context = emptyChoiceContext, meta = emptyMetadata

  case result.output of
    TransferInstructionResult_Completed receiverHoldings -> do
      let [bobHoldingI] = receiverHoldings
      let bobHolding : ContractId CIP56Holding = fromInterfaceContractId bobHoldingI
      Some bh <- queryContractId bob bobHolding
      assertMsg "Bob has 200" (bh.amount == 200.0)
    _ -> fail "Expected completed transfer"

  case result.senderChangeCids of
    [changeCidI] -> do
      let changeCid : ContractId CIP56Holding = fromInterfaceContractId changeCidI
      Some ch <- queryContractId alice changeCid
      assertMsg "Alice has 300 change" (ch.amount == 300.0)
    _ -> fail "Expected one sender change holding"

  debug "Transfer via factory test passed!"
  pure ()

testTransferMultipleInputs : Script ()
testTransferMultipleInputs = script do
  issuer <- allocateTestParty "issuer"
  alice  <- allocateTestParty "alice"
  bob    <- allocateTestParty "bob"

  let instrumentId = InstrumentId with admin = issuer, id = "TEST"
  let meta = mkMetadata
        [ ("splice.chainsafe.io/name", "Test Token")
        , ("splice.chainsafe.io/symbol", "TEST")
        , ("splice.chainsafe.io/decimals", "18")
        ]

  tmCid <- submit issuer do
    createCmd CIP56Manager with issuer, instrumentId, meta

  h1 <- submit issuer do exerciseCmd tmCid Mint with to = alice, amount = 100.0
  h2 <- submit issuer do exerciseCmd tmCid Mint with to = alice, amount = 150.0
  h3 <- submit issuer do exerciseCmd tmCid Mint with to = alice, amount = 50.0

  factoryCid <- submit issuer do
    createCmd CIP56TransferFactory with admin = issuer

  let now = time (date 2025 Jan 15) 12 0 0
  setTime now

  result <- submitMulti [alice] [issuer] do
    exerciseCmd (toInterfaceContractId @TransferFactory factoryCid) TransferFactory_Transfer with
      expectedAdmin = issuer
      transfer = Transfer with
        sender = alice
        receiver = bob
        amount = 250.0
        instrumentId
        requestedAt = now
        executeBefore = addRelTime now (hours 1)
        inputHoldingCids =
          [ toInterfaceContractId @Holding h1
          , toInterfaceContractId @Holding h2
          , toInterfaceContractId @Holding h3
          ]
        meta = emptyMetadata
      extraArgs = ExtraArgs with context = emptyChoiceContext, meta = emptyMetadata

  case result.output of
    TransferInstructionResult_Completed receiverHoldings -> do
      let [bobHoldingI] = receiverHoldings
      let bobHolding : ContractId CIP56Holding = fromInterfaceContractId bobHoldingI
      Some bh <- queryContractId bob bobHolding
      assertMsg "Bob has 250" (bh.amount == 250.0)
    _ -> fail "Expected completed transfer"

  case result.senderChangeCids of
    [changeCidI] -> do
      let changeCid : ContractId CIP56Holding = fromInterfaceContractId changeCidI
      Some ch <- queryContractId alice changeCid
      assertMsg "Alice has 50 change (300 - 250)" (ch.amount == 50.0)
    _ -> fail "Expected one sender change holding"

  debug "Multi-input transfer test passed!"
  pure ()

testTransferExactAmount : Script ()
testTransferExactAmount = script do
  issuer <- allocateTestParty "issuer"
  alice  <- allocateTestParty "alice"
  bob    <- allocateTestParty "bob"

  let instrumentId = InstrumentId with admin = issuer, id = "TEST"
  let meta = mkMetadata
        [ ("splice.chainsafe.io/symbol", "TEST")
        ]

  tmCid <- submit issuer do
    createCmd CIP56Manager with issuer, instrumentId, meta

  aliceHolding <- submit issuer do
    exerciseCmd tmCid Mint with to = alice, amount = 100.0

  factoryCid <- submit issuer do
    createCmd CIP56TransferFactory with admin = issuer

  let now = time (date 2025 Jan 15) 12 0 0
  setTime now

  result <- submitMulti [alice] [issuer] do
    exerciseCmd (toInterfaceContractId @TransferFactory factoryCid) TransferFactory_Transfer with
      expectedAdmin = issuer
      transfer = Transfer with
        sender = alice
        receiver = bob
        amount = 100.0
        instrumentId
        requestedAt = now
        executeBefore = addRelTime now (hours 1)
        inputHoldingCids = [toInterfaceContractId @Holding aliceHolding]
        meta = emptyMetadata
      extraArgs = ExtraArgs with context = emptyChoiceContext, meta = emptyMetadata

  case result.output of
    TransferInstructionResult_Completed _ -> pure ()
    _ -> fail "Expected completed transfer"

  assertMsg "No sender change (exact amount)" (null result.senderChangeCids)

  debug "Exact-amount transfer test passed!"
  pure ()

testHoldingInterface : Script ()
testHoldingInterface = script do
  issuer <- allocateTestParty "issuer"
  alice  <- allocateTestParty "alice"

  let instrumentId = InstrumentId with admin = issuer, id = "IF-TEST"
  let meta = mkMetadata [("splice.chainsafe.io/symbol", "IFT")]

  tmCid <- submit issuer do
    createCmd CIP56Manager with issuer, instrumentId, meta

  holdingCid <- submit issuer do
    exerciseCmd tmCid Mint with to = alice, amount = 42.0

  let holdingIfaceCid = toInterfaceContractId @Holding holdingCid

  Some holdingView <- queryInterfaceContractId alice holdingIfaceCid
  assertMsg "owner via interface" (holdingView.owner == alice)
  assertMsg "amount via interface" (holdingView.amount == 42.0)
  assertMsg "instrumentId via interface" (holdingView.instrumentId == instrumentId)
  assertMsg "lock via interface" (holdingView.lock == None)

  debug "Holding interface test passed!"
  pure ()
